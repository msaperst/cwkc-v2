name: Unit Tests

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  python-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt
          pip install pytest pytest-cov coverage

      - name: Run tests
        run: |
          set -o pipefail
          pytest --cov=scraper --cov-report=xml --cov-report=term-missing --cov-report=html scraper/tests --maxfail=1 --disable-warnings -q | tee coverage.txt
          
          start_line=$(grep -n "^Name" coverage.txt | cut -d: -f1 | head -n 1)
          if [ -n "$start_line" ]; then
            tail -n +"$start_line" coverage.txt > coverage_summary.txt
          else
            echo "âš ï¸ Coverage summary header not found" > coverage_summary.txt
          fi
          
          echo "COVERAGE_OUTPUT<<EOF" >> $GITHUB_ENV
          cat coverage_summary.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Upload coverage summary to PR
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage-html
          path: htmlcov/
          retention-days: 7

      - name: Upload Python coverage.xml
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage-xml
          path: coverage.xml
          retention-days: 7

      - name: Comment coverage summary on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: python-code-coverage-report
          message: |
            ### ðŸ§ª Python Code Coverage Summary
            ```
            ${{ env.COVERAGE_OUTPUT }}
            ```
            
            âœ… [View full coverage report (artifact)](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          append: false

  javascript-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node 24
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install dependencies
        run: |
          npm ci

      - name: Run tests
        run: |
          set -o pipefail
          npm test | tee coverage.txt
          
          start_line=$(grep -n "^----------|" coverage.txt | cut -d: -f1 | head -n 1)
          if [ -n "$start_line" ]; then
            tail -n +"$start_line" coverage.txt > coverage_summary.txt
          else
            echo "âš ï¸ Coverage summary header not found" > coverage_summary.txt
          fi
          
          echo "COVERAGE_OUTPUT<<EOF" >> $GITHUB_ENV
          cat coverage_summary.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Upload coverage summary to PR
        uses: actions/upload-artifact@v4
        with:
          name: javascript-coverage-html
          path: coverage/
          retention-days: 7

      - name: Upload JS lcov.info
        uses: actions/upload-artifact@v4
        with:
          name: javascript-coverage-lcov
          path: coverage/lcov.info
          retention-days: 7

      - name: Comment coverage summary on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: javascript-code-coverage-report
          message: |
            ### ðŸ§ª Javascript Code Coverage Summary
            ```
            ${{ env.COVERAGE_OUTPUT }}
            ```
            
            âœ… [View full coverage report (artifact)](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          append: false

  sonarcloud:
    runs-on: ubuntu-latest
    needs:
      - python-test
      - javascript-test

    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (for scanner internal deps)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python (if scanner needs to detect local environment)
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Download python coverage.xml
        uses: actions/download-artifact@v4
        with:
          name: python-coverage-xml
          path: .

      - name: Fix Python coverage paths for SonarCloud
        run: |
          sed -i "s|/home/runner/work/[^/]*/[^/]*|/github/workspace|g" coverage.xml

      - name: Download JS lcov.info
        uses: actions/download-artifact@v4
        with:
          name: javascript-coverage-lcov
          path: coverage

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .

      - name: SonarCloud Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1
        timeout-minutes: 15
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}